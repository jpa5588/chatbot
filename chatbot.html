<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NFL Chat</title>
  <style>
    :root {
      --nfl-blue: #013369;
      --nfl-red: #d50a0a;
      --field-green: #0b6623;
      --turf-gray: #1e1f26;
      --yardline: #ffffff30;
      --me: #01336933;
      --bot: #ffffff22;
      --text: #f5f6fa;
      --accent: #d50a0a;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background-color: #0b6623;
      background-image:
        url("https://www.transparenttextures.com/patterns/grass.png"),
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.06) 0px,
          rgba(255,255,255,0.06) 2px,
          transparent 2px,
          transparent 80px
        );
      background-size: auto, 100% 82px;
    }

    .chat {
      width: 95%;
      max-width: 900px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      background:
        linear-gradient(160deg, rgba(0,0,0,0.85), rgba(10,10,15,0.95)),
        url("https://www.transparenttextures.com/patterns/football-leather.png");
      background-size: cover;
      background-blend-mode: overlay;
      border-radius: 18px;
      overflow: hidden;
      border: 3px solid #ffffff33;
      box-shadow: 0 0 50px #00000099;
    }

    .chat::before {
      content: "üèà NFL Chat Center";
      display: block;
      text-align: center;
      background: linear-gradient(to right, var(--nfl-red), var(--nfl-blue));
      padding: 14px 0;
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 1.2em;
      border-bottom: 2px solid #fff2;
      color: #fff;
      text-shadow: 0 0 4px #000;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: repeating-linear-gradient(
        to bottom,
        rgba(30,31,38,0.9),
        rgba(30,31,38,0.9) 38px,
        var(--yardline) 40px
      );
      scroll-behavior: smooth;
    }

    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 15px;
      line-height: 1.4;
      animation: fadeIn 0.2s ease-out;
      color: #fff;
    }
    .me {
      align-self: flex-end;
      background: linear-gradient(145deg, var(--nfl-blue), #0352a0);
      border: 1px solid #ffffff33;
    }
    .bot {
      align-self: flex-start;
      background: linear-gradient(145deg, #2b2b2b, #1a1a1a);
      border: 1px solid #ffffff11;
    }
	.bot.wide {
	  max-width: 100% !important;
	  width: 100%;
	  align-self: flex-start;
	  background: transparent; /* table has its own style */
	  border: none;
	  padding: 0;
	}

    .inputbar {
      display: flex;
      gap: 10px;
      background: #000814;
      padding: 12px;
      border-top: 2px solid #ffffff22;
    }
    input[type=text] {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #0f172a;
      color: #fff;
      font-size: 15px;
    }
    input[type=text]::placeholder { color: #ccc; }
    button {
      padding: 12px 16px;
      border-radius: 10px;
      background: linear-gradient(to right, var(--nfl-red), #a30707);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    button:hover {
      background: linear-gradient(to right, #ff3c3c, var(--nfl-red));
      transform: translateY(-1px);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      color: #fff;
      font-size: 14px;
	  background: #0d0d0d;   /* ‚¨Ö NEW: solid black background */
      border-radius: 8px;     /* optional: cleaner shape */
      overflow: hidden;       /* ensures rounded corners apply */
    }
    th, td {
      padding: 8px;
      border: 1px solid #ffffff33;
      text-align: left;
    }
    th {
      background: linear-gradient(145deg, var(--nfl-blue), var(--nfl-red));
      color: #fff;
      font-weight: bold;
    }
    tr:nth-child(even) { background-color: #ffffff05; }

    .hint {
      color: #aaa;
      font-size: 13px;
      text-align: center;
      background: #000814;
      padding: 6px 0;
      border-top: 1px solid #222;
    }
    .error { color: #ff4d4d; font-weight: bold; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--nfl-blue), var(--nfl-red));
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="chat">
    <div class="messages" id="messages">
      <div class="msg bot">
        Welcome to the <strong>NFL Chat Center</strong>!<br>
        Type <code>standings</code> to fetch the latest NFL standings.
      </div>
    </div>

    <div class="hint">Example: type <code>standings</code></div>
    <form class="inputbar" id="form">
      <input id="prompt" type="text" placeholder="Please ask what you want and press Enter‚Ä¶" autocomplete="off">
      <button id="sendBtn" type="submit">Send</button>
    </form>
  </div>

  <script>
  // ===== API Config=====
  const middleware_server_url = "/api/middlewarelogic.php";
  const DEFAULT_KEYWORD = "standings";

  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const messages = $("#messages");

  function buildUrl(keyword = DEFAULT_KEYWORD) {
    const params = new URLSearchParams({
      mode: "standings",
      keyword: keyword
      // no need to send season if you‚Äôre hardcoding it in PHP
    });
    return `${middleware_server_url}?${params.toString()}`;
  }

  function addMsg(html, who = "bot") {
    const div = document.createElement("div");
    div.className = `msg ${who}`;
    div.innerHTML = html;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // Small helper to avoid HTML injection / broken layout
  function escapeHtml(value) {
    if (value === null || value === undefined) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // ===== Generic table renderer for any endpoint =====
  function renderStandingsTable(apiData) {
  const rows = apiData.rows || [];
  if (!rows.length) return "<div>No data found.</div>";

  // 1) Figure out columns: use apiData.columns if provided, otherwise infer
  let columns;
  if (Array.isArray(apiData.columns) && apiData.columns.length) {
    columns = apiData.columns;
  } else {
    columns = Object.keys(rows[0]);
  }

  // 2) Filter options are just the column names
  const filterOptions = columns.slice(); // shallow copy

  const filterBar = `
    <div style="margin-bottom:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <label for="filterCol"><strong>Filter by:</strong></label>
      <select id="filterCol" style="padding:6px;border-radius:8px;background:#0f172a;color:#fff;border:1px solid #555;">
        <option value="">-- Select column --</option>
        ${filterOptions.map(o => `<option value="${o}">${o}</option>`).join("")}
      </select>
      <input type="text" id="filterInput" placeholder="Enter value..."
        style="padding:6px;border-radius:8px;background:#0f172a;color:#fff;border:1px solid #555;">
      <button type="button" id="applyFilter" style="padding:6px 12px;border-radius:8px;background:linear-gradient(to right,#d50a0a,#a30707);color:#fff;border:none;cursor:pointer;">Apply</button>
      <button type="button" id="clearFilter" style="padding:6px 12px;border-radius:8px;background:#555;color:#fff;border:none;cursor:pointer;">Clear</button>
    </div>
  `;

  // 3) Build the table using those dynamic columns
  const headerHtml = columns
    .map(col => `<th>${escapeHtml(col)}</th>`)
    .join("");

  const bodyHtml = rows
    .map(row => {
      const cells = columns
        .map(col => `<td>${escapeHtml(row[col])}</td>`)
        .join("");
      return `<tr>${cells}</tr>`;
    })
    .join("");

  const tableHtml = `
    ${filterBar}
    <table id="resultsTable">
      <thead>
        <tr>${headerHtml}</tr>
      </thead>
      <tbody>
        ${bodyHtml}
      </tbody>
    </table>
  `;

  // 4) Wire up the filter behavior *after* the HTML is injected
  setTimeout(() => {
    const filterCol  = document.getElementById("filterCol");
    const filterInput = document.getElementById("filterInput");
    const applyBtn   = document.getElementById("applyFilter");
    const clearBtn   = document.getElementById("clearFilter");
    const table      = document.getElementById("resultsTable");

    if (!filterCol || !filterInput || !applyBtn || !clearBtn || !table) return;

    applyBtn.addEventListener("click", () => {
      const col = filterCol.value;
      const val = filterInput.value.trim().toLowerCase();
      if (!col || !val) return;

      const colIndex = filterOptions.indexOf(col);
      const rowsEls = table.querySelectorAll("tbody tr");

      rowsEls.forEach(r => {
        const cellText = (r.children[colIndex]?.textContent || "").toLowerCase();
        r.style.display = cellText.includes(val) ? "" : "none";
      });
    });

    clearBtn.addEventListener("click", () => {
      filterCol.value = "";
      filterInput.value = "";
      table.querySelectorAll("tbody tr").forEach(r => (r.style.display = ""));
    });
  }, 0);

  return tableHtml;
}

  // ===== Fetch from your middleware (JSON) =====
  async function fetchStandings(keyword = DEFAULT_KEYWORD) {
    const url = buildUrl(keyword);
    const res = await fetch(url, { headers: { Accept: "application/json" } });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    if (!data || !Array.isArray(data.rows)) {
      throw new Error("Invalid data received from server");
    }

    return data; // { count, rows }
  }

  // ===== Chat flow =====
  $("#form").addEventListener("submit", async e => {
    e.preventDefault();
    const input = $("#prompt");
    const text = input.value.trim();
    if (!text) return;

    addMsg(text, "me");
    input.value = "";

    const lower = text.toLowerCase();

    // Only respond when user mentions "standings"
    if (!lower.includes("standings")) {
      addMsg(
        'Type <code>standings</code> to fetch the latest NFL standings.',
        "bot"
      );
      return;
    }

    const keyword = "standings"; // what we send to middleware
    addMsg(`Fetching current NFL ${keyword}‚Ä¶`, "bot");

    try {
      const data = await fetchStandings(keyword); // { count, rows }
      const tableHtml = renderStandingsTable(data);
      const last = messages.lastElementChild;
		last.classList.add("wide"); 
		last.innerHTML = `
		<div>${keyword.charAt(0).toUpperCase() + keyword.slice(1)} ‚Äî ${data.rows.length} record(s)</div>
		${tableHtml}
	`;
    } catch (err) {
      messages.lastElementChild.innerHTML =
        `<div class="error">Failed to load ${keyword}: ${err.message}</div>`;
    }
  });
  </script>
</body>
</html>
