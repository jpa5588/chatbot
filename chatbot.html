<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NFL Chat</title>
  <style>
    :root {
      --nfl-blue: #013369;
      --nfl-red: #d50a0a;
      --field-green: #0b6623;
      --turf-gray: #1e1f26;
      --yardline: #ffffff30;
      --me: #01336933;
      --bot: #ffffff22;
      --text: #f5f6fa;
      --accent: #d50a0a;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background-color: #0b6623;
      background-image:
        url("https://www.transparenttextures.com/patterns/grass.png"),
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.06) 0px,
          rgba(255,255,255,0.06) 2px,
          transparent 2px,
          transparent 80px
        );
      background-size: auto, 100% 82px;
    }

    .chat {
      width: 95%;
      max-width: 900px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      background:
        linear-gradient(160deg, rgba(0,0,0,0.85), rgba(10,10,15,0.95)),
        url("https://www.transparenttextures.com/patterns/football-leather.png");
      background-size: cover;
      background-blend-mode: overlay;
      border-radius: 18px;
      overflow: hidden;
      border: 3px solid #ffffff33;
      box-shadow: 0 0 50px #00000099;
    }

    .chat::before {
      content: "üèà NFL Chat Center";
      display: block;
      text-align: center;
      background: linear-gradient(to right, var(--nfl-red), var(--nfl-blue));
      padding: 14px 0;
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 1.2em;
      border-bottom: 2px solid #fff2;
      color: #fff;
      text-shadow: 0 0 4px #000;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: repeating-linear-gradient(
        to bottom,
        rgba(30,31,38,0.9),
        rgba(30,31,38,0.9) 38px,
        var(--yardline) 40px
      );
      scroll-behavior: smooth;
    }

    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 15px;
      line-height: 1.4;
      animation: fadeIn 0.2s ease-out;
      color: #fff;
    }
    .me {
      align-self: flex-end;
      background: linear-gradient(145deg, var(--nfl-blue), #0352a0);
      border: 1px solid #ffffff33;
    }
    .bot {
      align-self: flex-start;
      background: linear-gradient(145deg, #2b2b2b, #1a1a1a);
      border: 1px solid #ffffff11;
    }
    .bot.wide {
      max-width: 100% !important;
      width: 100%;
      align-self: flex-start;
      background: transparent;
      border: none;
      padding: 0;
    }

    .inputbar {
      display: flex;
      gap: 10px;
      background: #000814;
      padding: 12px;
      border-top: 2px solid #ffffff22;
    }
    input[type=text] {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #0f172a;
      color: #fff;
      font-size: 15px;
    }
    input[type=text]::placeholder { color: #ccc; }
    button {
      padding: 12px 16px;
      border-radius: 10px;
      background: linear-gradient(to right, var(--nfl-red), #a30707);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    button:hover {
      background: linear-gradient(to right, #ff3c3c, var(--nfl-red));
      transform: translateY(-1px);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      color: #fff;
      font-size: 14px;
      background: #0d0d0d;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ffffff33;
      text-align: left;
    }
    th {
      background: linear-gradient(145deg, var(--nfl-blue), var(--nfl-red));
      color: #fff;
      font-weight: bold;
    }
    tr:nth-child(even) { background-color: #ffffff05; }

    .hint {
      color: #aaa;
      font-size: 13px;
      text-align: center;
      background: #000814;
      padding: 6px 0;
      border-top: 1px solid #222;
    }
    .error { color: #ff4d4d; font-weight: bold; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--nfl-blue), var(--nfl-red));
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="chat">
    <div class="messages" id="messages">
      <div class="msg bot">
        Welcome to the <strong>NFL Chat Center</strong>!<br>
        Type <code>standings</code> to fetch the latest NFL standings or
        <code>players</code> to see available free agent players.
      </div>
    </div>

    <div class="hint">
      Example: type <code>standings</code> or <code>players</code>
    </div>
    <form class="inputbar" id="form">
      <input id="prompt" type="text" placeholder="Please ask what you want and press Enter‚Ä¶" autocomplete="off">
      <button id="sendBtn" type="submit">Send</button>
    </form>
  </div>

  <script>
  // ===== API Config =====
  const middleware_server_url = "/api/middlewarelogic.php";
  const DEFAULT_KEYWORD = "standings";

  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const messages = $("#messages");

  function buildUrl(keyword = DEFAULT_KEYWORD) {
    const params = new URLSearchParams({
      mode: "standings",      // middleware still expects 'standings' mode
      keyword: keyword        // 'standings' or 'players'
    });
    return `${middleware_server_url}?${params.toString()}`;
  }

  function addMsg(html, who = "bot") {
    const div = document.createElement("div");
    div.className = `msg ${who}`;
    div.innerHTML = html;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function escapeHtml(value) {
    if (value === null || value === undefined) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  const MAX_ROWS = 200;

  // ===== Generic table renderer for any endpoint (full-data filter + 200-row display) =====
  function renderStandingsTable(apiData) {
    // unique suffix so multiple tables can coexist independently
    const uid = "tbl_" + Math.random().toString(36).slice(2, 10);

    const allRows = apiData.rows || [];
    let currentRows = allRows.slice();  // start with full dataset

    if (!currentRows.length) {
      return "<div>No data found.</div>";
    }

    // Determine columns
    let columns;
    if (Array.isArray(apiData.columns) && apiData.columns.length) {
      columns = apiData.columns;
    } else {
      columns = Object.keys(currentRows[0]);
    }

    const filterOptions = columns.slice();

    const filterBar = `
      <div style="margin-bottom:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <label for="filterCol_${uid}"><strong>Filter by:</strong></label>
        <select id="filterCol_${uid}"
          style="padding:6px;border-radius:8px;background:#0f172a;color:#fff;border:1px solid #555;">
          <option value="">-- Select column --</option>
          ${filterOptions.map(o => `<option value="${o}">${o}</option>`).join("")}
        </select>

        <input type="text" id="filterInput_${uid}" placeholder="Enter value..."
          style="padding:6px;border-radius:8px;background:#0f172a;color:#fff;border:1px solid #555;">

        <button type="button" id="applyFilter_${uid}"
          style="padding:6px 12px;border-radius:8px;background:linear-gradient(to right,#d50a0a,#a30707);
                 color:#fff;border:none;cursor:pointer;">
          Apply
        </button>

        <button type="button" id="clearFilter_${uid}"
          style="padding:6px 12px;border-radius:8px;background:#555;color:#fff;border:none;cursor:pointer;">
          Clear
        </button>

        <span id="rowsInfo_${uid}" style="margin-left:auto;font-size:12px;color:#ccc;"></span>
      </div>
    `;

    const headerHtml = columns
      .map(col => `<th>${escapeHtml(col)}</th>`)
      .join("");

    const tableHtml = `
      ${filterBar}
      <table id="resultsTable_${uid}">
        <thead>
          <tr>${headerHtml}</tr>
        </thead>
        <tbody id="resultsTbody_${uid}"></tbody>
      </table>
    `;

    // Wire up this specific table after it is in the DOM
    setTimeout(() => {
      const filterCol   = document.getElementById(`filterCol_${uid}`);
      const filterInput = document.getElementById(`filterInput_${uid}`);
      const applyBtn    = document.getElementById(`applyFilter_${uid}`);
      const clearBtn    = document.getElementById(`clearFilter_${uid}`);
      const tbody       = document.getElementById(`resultsTbody_${uid}`);
      const infoSpan    = document.getElementById(`rowsInfo_${uid}`);

      if (!filterCol || !tbody) return;

      function renderTablePage(page = 1) {
        const total = currentRows.length;
        const start = (page - 1) * MAX_ROWS;
        const slice = currentRows.slice(start, start + MAX_ROWS);

        const bodyHtml = slice.map(row => {
          const cells = columns
            .map(col => `<td>${escapeHtml(row[col])}</td>`)
            .join("");
          return `<tr>${cells}</tr>`;
        }).join("");

        tbody.innerHTML = bodyHtml;

        if (infoSpan) {
          const filteredText = (allRows.length === total)
            ? ""
            : ` (filtered from ${allRows.length})`;
          infoSpan.textContent =
            `Showing ${slice.length} of ${total} row(s)${filteredText}`;
        }
      }

      function applyFilterHandler() {
        const col = filterCol.value;
        const val = filterInput.value.trim().toLowerCase();

        if (!col || !val) {
          currentRows = allRows.slice();
        } else {
          currentRows = allRows.filter(row => {
            const cell = row[col];
            const text = (cell === null || cell === undefined)
              ? ""
              : String(cell).toLowerCase();
            return text.includes(val);
          });
        }

        renderTablePage(1);
      }

      applyBtn.addEventListener("click", applyFilterHandler);

      clearBtn.addEventListener("click", () => {
        filterCol.value = "";
        filterInput.value = "";
        currentRows = allRows.slice();
        renderTablePage(1);
      });

      filterInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") applyFilterHandler();
      });

      // Initial render
      renderTablePage(1);
    }, 0);

    return tableHtml;
  }

  // ===== Fetch from your middleware (JSON) =====
  async function fetchStandings(keyword = DEFAULT_KEYWORD) {
    const url = buildUrl(keyword);
    const res = await fetch(url, { headers: { Accept: "application/json" } });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    if (!data || !Array.isArray(data.rows)) {
      throw new Error("Invalid data received from server");
    }
    return data; // { count, rows }
  }

  // ===== Chat flow =====
  $("#form").addEventListener("submit", async e => {
    e.preventDefault();
    const input = $("#prompt");
    const text = input.value.trim();
    if (!text) return;

    addMsg(text, "me");
    input.value = "";

    const lower = text.toLowerCase();

    let keyword;
    let label;

    if (lower.includes("standings")) {
      keyword = "standings";
      label   = "Standings";
    } else if (lower.includes("player")) { // matches "player" or "players"
      keyword = "players";
      label   = "NFL Players";
    } else {
      addMsg(
        'I currently understand <code>standings</code> and <code>players</code>.',
        "bot"
      );
      return;
    }

    addMsg(`Fetching NFL ${label}‚Ä¶`, "bot");

    try {
      const data = await fetchStandings(keyword);
      const tableHtml = renderStandingsTable(data);
      const last = messages.lastElementChild;
      last.classList.add("wide");
      last.innerHTML = `
        <div>${label} ‚Äî ${data.rows.length} record(s) (showing up to ${MAX_ROWS})</div>
        ${tableHtml}
      `;
    } catch (err) {
      messages.lastElementChild.innerHTML =
        `<div class="error">Failed to load ${label}: ${err.message}</div>`;
    }
  });
</script>
</body>
</html>
